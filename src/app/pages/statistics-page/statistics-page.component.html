<mat-card>
  <mat-card-title>Statistische Kurzanalysen</mat-card-title>
  <mat-card-content>
    <form [formGroup]="timeForm" (ngSubmit)="onCompute()" class="controls">
      <div class="groups">
        <app-sensor-group-selector
          formControlName="group1"
          label="Gruppe 1"
        ></app-sensor-group-selector>
        <app-sensor-group-selector
          formControlName="group2"
          label="Gruppe 2"
        ></app-sensor-group-selector>
      </div>

      <app-date-time-picker formControlName="dateTimeRange"></app-date-time-picker>
      <mat-error *ngIf="submitted && timeForm.get('dateTimeRange')?.hasError('required')">
        Bitte komplettes Zeitintervall auswählen.
      </mat-error>
      <mat-error *ngIf="submitted && timeForm.get('dateTimeRange')?.hasError('rangeInvalid')">
        „Von“ darf nicht nach „Bis“ liegen.
      </mat-error>

      <button mat-raised-button color="primary" type="submit">Berechnen</button>

      <button mat-raised-button type="button" (click)="onClear()">Ergebnisse löschen</button>
    </form>
    <mat-error *ngIf="errorMessage">{{ errorMessage }}</mat-error>

    <div class="results" *ngIf="resultsGroup1 && resultsGroup2">
      <mat-card class="result">
        <mat-card-title>Gruppe 1</mat-card-title>
        <app-statistics-display [stats]="resultsGroup1"></app-statistics-display>
      </mat-card>
      <mat-card class="result">
        <mat-card-title>Gruppe 2</mat-card-title>
        <app-statistics-display [stats]="resultsGroup2"></app-statistics-display>
      </mat-card>
    </div>

    <div *ngIf="correlation !== undefined" class="correlation">
      <p>Pearson-Korrelation: {{ correlation | number: '1.2-2' }}</p>
    </div>
    <button
      mat-raised-button
      type="button"
      color="accent"
      [disabled]="!canShowAnomalies"
      (click)="onShowAnomalies()"
    >
      Anomalien anzeigen
    </button>

    <!-- Scatter-Charts -->
    <div class="chart-section" *ngIf="resultsAvailable">
      <app-scatter-chart
        [label]="'Gruppe1'"
        [points]="resultsGroup1?.series?.[0]?.points ?? []"
        [anomalies]="anomaliesPointsGroup1"
        [simultaneous]="simultaneousAnomalies"
        [lowThreshold]="(resultsGroup1?.p25 ?? 0) - 1.5 * (resultsGroup1?.iqr ?? 0)"
        [highThreshold]="(resultsGroup1?.p75 ?? 0) + 1.5 * (resultsGroup1?.iqr ?? 0)"
      ></app-scatter-chart>

      <app-scatter-chart
        [label]="'Gruppe2'"
        [points]="resultsGroup2?.series?.[0]?.points ?? []"
        [anomalies]="anomaliesPointsGroup2"
        [simultaneous]="simultaneousAnomalies"
        [lowThreshold]="(resultsGroup2?.p25 ?? 0) - 1.5 * (resultsGroup2?.iqr ?? 0)"
        [highThreshold]="(resultsGroup2?.p75 ?? 0) + 1.5 * (resultsGroup2?.iqr ?? 0)"
      ></app-scatter-chart>
    </div>

    <!-- Anomaly Lists -->
    <div *ngIf="anomalyChecked">
      <div *ngIf="anomaliesVisible; else noAnomalyTemplate" class="anomalies">
        <app-anomaly-list
          [anomalies]="anomaliesGroup1"
          [otherTimestamps]="otherTimestampsGroup2"
          otherLabel="In Gruppe2"
          title="Gruppe1"
        ></app-anomaly-list>

        <app-anomaly-list
          [anomalies]="anomaliesGroup2"
          [otherTimestamps]="otherTimestampsGroup1"
          otherLabel="In Gruppe1"
          title="Gruppe2"
        ></app-anomaly-list>
      </div>
      <ng-template #noAnomalyTemplate>
        <p><strong> Keine Ausreißer im ausgewählten Zeitraum gefunden.</strong></p>
      </ng-template>
    </div>
  </mat-card-content>
</mat-card>
