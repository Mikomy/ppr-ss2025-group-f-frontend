<div class="sensor-container">
  <h1 class="sensor_headline">
    <i class="fas fa-chart-bar"></i>
    Statistische Kurzanalysen
  </h1>

  <div class="config-section">
    <form [formGroup]="timeForm" (ngSubmit)="onCompute()" class="controls">
      <div class="stat-card">
        <div class="groups">
          <app-sensor-group-selector
            formControlName="group1"
            label="Gruppe 1"
          ></app-sensor-group-selector>
          <app-sensor-group-selector
            formControlName="group2"
            label="Gruppe 2"
          ></app-sensor-group-selector>
        </div>

        <app-date-time-picker formControlName="dateTimeRange"></app-date-time-picker>

        <div class="button-group">
          <button mat-raised-button color="primary" type="submit">
            <i class="fas fa-calculator"></i> Berechnen
          </button>
          <button mat-raised-button type="button" (click)="onClear()">
            <i class="fas fa-trash"></i> Ergebnisse löschen
          </button>
        </div>

        <mat-error *ngIf="errorMessage">{{ errorMessage }}</mat-error>
      </div>
    </form>
  </div>

  <div class="results-section" *ngIf="resultsAvailable">
    <div class="stats-grid">
      <div class="stat-card">
        <h3>Gruppe 1</h3>
        <app-statistics-display [stats]="resultsGroup1"></app-statistics-display>
      </div>
      <div class="stat-card">
        <h3>Gruppe 2</h3>
        <app-statistics-display [stats]="resultsGroup2"></app-statistics-display>
      </div>
    </div>

    <div class="correlation-card stat-card" *ngIf="correlation !== undefined">
      <div class="card-icon">
        <i class="fas fa-link"></i>
      </div>
      <div class="card-content">
        <h3>Pearson-Korrelation</h3>
        <p class="value">{{ correlation | number: '1.2-2' }}</p>
      </div>
    </div>

    <button
      mat-raised-button
      class="anomaly-button"
      type="button"
      color="accent"
      [disabled]="!canShowAnomalies"
      (click)="onShowAnomalies()"
    >
      <i class="fas fa-search"></i> Anomalien anzeigen
    </button>

    <!-- Scatter-Charts -->
    <div class="chart-section" *ngIf="resultsAvailable">
      <app-scatter-chart
        [label]="'Gruppe1'"
        [points]="resultsGroup1?.series?.[0]?.points ?? []"
        [anomalies]="anomaliesPointsGroup1"
        [simultaneous]="simultaneousAnomalies"
        [lowThreshold]="(resultsGroup1?.p25 ?? 0) - 1.5 * (resultsGroup1?.iqr ?? 0)"
        [highThreshold]="(resultsGroup1?.p75 ?? 0) + 1.5 * (resultsGroup1?.iqr ?? 0)"
      ></app-scatter-chart>

      <app-scatter-chart
        [label]="'Gruppe2'"
        [points]="resultsGroup2?.series?.[0]?.points ?? []"
        [anomalies]="anomaliesPointsGroup2"
        [simultaneous]="simultaneousAnomalies"
        [lowThreshold]="(resultsGroup2?.p25 ?? 0) - 1.5 * (resultsGroup2?.iqr ?? 0)"
        [highThreshold]="(resultsGroup2?.p75 ?? 0) + 1.5 * (resultsGroup2?.iqr ?? 0)"
      ></app-scatter-chart>
    </div>

    <!-- Anomaly Lists -->
    <div *ngIf="anomalyChecked">
      <div *ngIf="anomaliesVisible; else noAnomalyTemplate" class="anomalies">
        <app-anomaly-list
          [anomalies]="anomaliesGroup1"
          [otherTimestamps]="otherTimestampsGroup2"
          otherLabel="In Gruppe2"
          title="Gruppe1"
        ></app-anomaly-list>

        <app-anomaly-list
          [anomalies]="anomaliesGroup2"
          [otherTimestamps]="otherTimestampsGroup1"
          otherLabel="In Gruppe1"
          title="Gruppe2"
        ></app-anomaly-list>
      </div>
      <ng-template #noAnomalyTemplate>
        <p><strong> Keine Ausreißer im ausgewählten Zeitraum gefunden.</strong></p>
      </ng-template>
    </div>
  </div>
</div>
